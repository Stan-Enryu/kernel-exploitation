#!/bin/bash

if [[ $# -eq 0 ]] ; then
    echo 'usage : compress <name cpio> <name exploit>'
    echo ''
    echo 'Example'
    echo 'File cpio name : initramfs.cpio.gz '
    echo 'File exploit name : exploit.c (default)'
    echo 'command : compress initramfs exploit'

    exit 0
fi

if [ -z "$2" ] ; then
	exp="exploit.c"
else
	exp="$2.c"
fi

if [ ! -e "./$exp" ] || [ ! -d "$1" ]; then
	echo "File $exp or directory $1 doesn't exist"
	exit 0
fi

if [ -e "$1.cpio.gz" ]; then
	gcc -static -o exploit $exp
	echo "Compile exploit.c"

	mv -f ./exploit ./$1/exploit
	cd $1
	find . -print0 \
	| cpio --null -o --format=newc \
	| gzip -9 > $1.cpio.gz
	mv -f ./$1.cpio.gz ../
    echo "Finish $1.cpio.gz"
elif [ -e "$1.cpio" ]; then
	gcc -m32 -static -o exploit $exp
	echo "Compile exploit.c"

	mv -f ./exploit ./$1/exploit
	cd $1
	find . -print0 | cpio -o --format=newc --null > ./$1.cpio
	mv -f ./$1.cpio ../
	echo "Finish $1.cpio"
else 
    echo "File does not exist"
fi

